# NCMIT - Leitor de Nota Fiscal com Supabase

Este é um guia completo para configurar e rodar o projeto NCMIT em sua máquina local, agora com autenticação de usuários.

## Pré-requisitos

- **Node.js**: Versão 18 ou superior.
- **npm**: Geralmente instalado com o Node.js.
- **Conta no Supabase**: Você precisará de uma conta gratuita no [Supabase](https://supabase.com/).

---

## Passo 1: Configuração do Supabase

1.  **Crie um Novo Projeto**:
    - Acesse seu [dashboard do Supabase](https://app.supabase.com/).
    - Clique em "New project" e siga as instruções.

2.  **Obtenha as Chaves da API**:
    - No menu lateral do seu projeto, vá para `Settings` (ícone de engrenagem) > `API`.
    - Copie o **Project URL**.
    - Copie a chave **anon public** da seção `Project API Keys`.

3.  **Crie as Tabelas no Banco de Dados (Script Definitivo com Autenticação)**:
    - No menu lateral, vá para `SQL Editor` (ícone de `</>`).
    - Clique em `+ New query`.
    - **IMPORTANTE**: Este script irá apagar tabelas antigas se elas existirem para criar a nova estrutura correta com autenticação.
    - Copie e cole o script SQL abaixo e clique em `RUN`.

    ```sql
    DROP TABLE IF EXISTS produtos CASCADE;
    DROP TABLE IF EXISTS notas_fiscais CASCADE;
    DROP TABLE IF EXISTS historico_calculo CASCADE;
    DROP TABLE IF EXISTS item_nota_fiscal CASCADE;
    DROP TABLE IF EXISTS nota_fiscal CASCADE;
    DROP TABLE IF EXISTS produto CASCADE;
    DROP TABLE IF EXISTS regra_tributacao CASCADE;
    DROP TABLE IF EXISTS usuario CASCADE;
    DROP TABLE IF EXISTS ncm CASCADE;
    DROP TABLE IF EXISTS estado CASCADE;
    
    CREATE TABLE IF NOT EXISTS estado (
        uf CHAR(2) PRIMARY KEY,
        nome VARCHAR(30) NOT NULL
    );

    CREATE TABLE IF NOT EXISTS ncm (
        codigo VARCHAR(8) PRIMARY KEY,
        descricao TEXT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS nota_fiscal (
        chave_acesso VARCHAR(44) PRIMARY KEY,
        user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
        numero VARCHAR(15) NOT NULL,
        data_emissao TIMESTAMPTZ NOT NULL,
        valor_total DECIMAL(15, 2) NOT NULL,
        imposto_total DECIMAL(15, 2) NOT NULL,
        nome_emitente TEXT,
        nome_destinatario TEXT,
        doc_destinatario TEXT,
        uf_emitente CHAR(2) REFERENCES estado(uf),
        uf_destinatario CHAR(2) REFERENCES estado(uf),
        indicador_ie_destinatario TEXT,
        regime_tributario_emitente TEXT,
        -- Colunas para análise fiscal automática
        imposto_estimado_total DECIMAL(15, 2),
        diferenca_imposto DECIMAL(15, 2),
        calculo_premissas TEXT,
        data_calculo TIMESTAMPTZ,
        possui_ncm_desconhecido BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS item_nota_fiscal (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        fk_nota_fiscal_chave_acesso VARCHAR(44) NOT NULL REFERENCES nota_fiscal(chave_acesso) ON DELETE CASCADE,
        codigo TEXT,
        codigo_ncm VARCHAR(8),
        descricao TEXT,
        quantidade DECIMAL(15, 4),
        unidade VARCHAR(6),
        valor_unitario DECIMAL(15, 10),
        valor_total DECIMAL(15, 2),
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS historico_calculo (
        id_historico BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        fk_nota_fiscal_chave_acesso VARCHAR(44) NOT NULL REFERENCES nota_fiscal(chave_acesso) ON DELETE CASCADE,
        data_calculo TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        valor_original DECIMAL(15, 2) NOT NULL,
        valor_tributado DECIMAL(15, 2) NOT NULL
    );

    ALTER TABLE estado ENABLE ROW LEVEL SECURITY;
    ALTER TABLE ncm ENABLE ROW LEVEL SECURITY;
    ALTER TABLE nota_fiscal ENABLE ROW LEVEL SECURITY;
    ALTER TABLE item_nota_fiscal ENABLE ROW LEVEL SECURITY;
    ALTER TABLE historico_calculo ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Public read access for states" ON estado FOR SELECT USING (true);
    CREATE POLICY "Public read access for NCM" ON ncm FOR SELECT USING (true);

    CREATE POLICY "Users can manage their own invoices" ON nota_fiscal
        FOR ALL
        USING (auth.uid() = user_id)
        WITH CHECK (auth.uid() = user_id);

    CREATE POLICY "Users can manage items of their own invoices" ON item_nota_fiscal
        FOR ALL
        USING ( (SELECT user_id FROM nota_fiscal WHERE chave_acesso = fk_nota_fiscal_chave_acesso) = auth.uid() );
        
    CREATE POLICY "Users can manage history of their own invoices" ON historico_calculo
        FOR ALL
        USING ( (SELECT user_id FROM nota_fiscal WHERE chave_acesso = fk_nota_fiscal_chave_acesso) = auth.uid() );

    CREATE INDEX IF NOT EXISTS idx_nf_data ON nota_fiscal (data_emissao);
    CREATE INDEX IF NOT EXISTS idx_nf_user_id ON nota_fiscal (user_id);
    CREATE INDEX IF NOT EXISTS idx_item_nf_fk ON item_nota_fiscal (fk_nota_fiscal_chave_acesso);
    CREATE INDEX IF NOT EXISTS idx_hist_fk ON historico_calculo (fk_nota_fiscal_chave_acesso);

    INSERT INTO public.estado (uf, nome) VALUES
    ('AC', 'Acre'), ('AL', 'Alagoas'), ('AP', 'Amapá'), ('AM', 'Amazonas'),
    ('BA', 'Bahia'), ('CE', 'Ceará'), ('DF', 'Distrito Federal'), ('ES', 'Espírito Santo'),
    ('GO', 'Goiás'), ('MA', 'Maranhão'), ('MT', 'Mato Grosso'), ('MS', 'Mato Grosso do Sul'),
    ('MG', 'Minas Gerais'), ('PA', 'Pará'), ('PB', 'Paraíba'), ('PR', 'Paraná'),
    ('PE', 'Pernambuco'), ('PI', 'Piauí'), ('RJ', 'Rio de Janeiro'), ('RN', 'Rio Grande do Norte'),
    ('RS', 'Rio Grande do Sul'), ('RO', 'Rondônia'), ('RR', 'Roraima'), ('SC', 'Santa Catarina'),
    ('SP', 'São Paulo'), ('SE', 'Sergipe'), ('TO', 'Tocantins')
    ON CONFLICT (uf) DO NOTHING;
    ```

---

## Passo 2: Configuração do Projeto Local

1.  **Crie o Arquivo de Ambiente**:
    - Na raiz do seu projeto, crie um arquivo chamado `.env`.
    - Adicione as chaves do Supabase que você copiou:

    ```
    REACT_APP_SUPABASE_URL=SUA_URL_DO_PROJETO_SUPABASE
    REACT_APP_SUPABASE_ANON_KEY=SUA_CHAVE_ANON_PUBLIC_DO_SUPABASE
    ```

2.  **Instale as Dependências**:
    - `npm install`

3.  **Rode o Projeto**:
    - `npm run dev`

Agora você está pronto para usar o NCMIT! Crie uma conta e comece a fazer o upload de suas notas fiscais.
